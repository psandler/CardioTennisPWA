@using CardioTennisPWA.Models
@using CardioTennisPWA.Services
@using Microsoft.AspNetCore.Components

@if (currentGameSession != null && currentGameSession.Sets.Count > 0)
{
    <div class="container-fluid h-100">
        <div class="row h-100 flex-column flex-md-row">
            <!-- Set Tabs: Horizontal on mobile, Vertical sidebar on desktop -->
            <div class="col-12 col-md-3 col-lg-2 bg-light border-bottom border-md-end p-0">
                <div class="d-flex flex-column flex-md-column h-100">
                    <div class="p-3 border-bottom bg-primary text-white d-none d-md-block">
                        <h6 class="mb-0">Sets</h6>
                    </div>
                    
                    <!-- Wrapper for scroll indicators (mobile only) -->
                    <div class="set-tabs-wrapper position-relative d-md-contents">
                        <!-- Left scroll arrow (mobile only) -->
                        <button class="scroll-arrow scroll-arrow-left d-md-none" 
                                type="button"
                                @onclick="ScrollTabsLeft"
                                @onclick:stopPropagation="true">
                            ‹
                        </button>
                        
                        <!-- Right scroll arrow (mobile only) -->
                        <button class="scroll-arrow scroll-arrow-right d-md-none" 
                                type="button"
                                @onclick="ScrollTabsRight"
                                @onclick:stopPropagation="true">
                            ›
                        </button>
                        
                        <!-- Mobile: horizontal scroll with snap, Desktop: vertical scroll -->
                        <div class="set-tabs-container d-flex flex-md-column overflow-auto flex-nowrap" 
                             style="-webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;"
                             @ref="tabsContainer"
                             @onscroll="HandleTabsScroll">
                        @foreach (var set in currentGameSession.Sets)
                        {
                            <button class="btn btn-link text-start text-md-start text-center flex-shrink-0 w-auto w-md-100 px-4 px-md-3 py-3 border-end border-md-bottom @(selectedSetNumber == set.Number ? "bg-white fw-bold" : "")"
                                    style="min-height: 48px; min-width: 100px; scroll-snap-align: start;"
                                    type="button"
                                    @onclick="() => SelectSet(set.Number)"
                                    @onclick:stopPropagation="true">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-secondary me-2">@set.Number</span>
                                    <span>Set @set.Number</span>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    @set.Matches.Count match@(set.Matches.Count != 1 ? "es" : "")
                                    @if (set.IsComplete)
                                    {
                                        <span class="badge bg-success ms-1">@(new MarkupString("&#10003;"))</span>
                                    }
                                </small>
                            </button>
                        }
                        </div>
                    </div>

                    <!-- View Scores and End Session Buttons -->
                    <div class="p-3 border-top d-flex flex-row flex-md-column gap-2">
                        <button class="btn btn-warning flex-grow-1" 
                                style="min-height: 48px;"
                                @onclick="ShowScores">
                            View Scores
                        </button>
                        <button class="btn btn-danger flex-grow-1" 
                                style="min-height: 48px;"
                                @onclick="ShowEndSessionConfirmation" 
                                disabled="@(!canEndSession || isEndingSession)">
                            @if (isEndingSession)
                            {
                                <span>Ending...</span>
                            }
                            else
                            {
                                <span>End Session</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content: Set Details -->
            <div class="col-12 col-md-9 col-lg-10 p-3 p-md-4">
                @if (selectedSet != null)
                {
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Set @selectedSet.Number</h3>
                            @if (selectedSet.IsComplete)
                            {
                                <span class="badge bg-success">Complete</span>
                            }
                            else
                            {
                                <span class="badge bg-primary">In Progress</span>
                            }
                        </div>

                        <!-- Matches in this set -->
                        @foreach (var match in selectedSet.Matches)
                        {
                            var isLatestMatch = match.Number == selectedSet.Matches.Count && !selectedSet.IsComplete;
                            var collapseId = $"collapse-set{selectedSet.Number}-match{match.Number}";
                            
                            <div class="card mb-2">
                                <div class="card-header" id="heading-set@(selectedSet.Number)-match@(match.Number)">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link text-decoration-none w-100 text-start d-flex justify-content-between align-items-center @(isLatestMatch ? "" : "collapsed")"
                                                style="min-height: 48px;"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#@collapseId"
                                                aria-expanded="@(isLatestMatch ? "true" : "false")"
                                                aria-controls="@collapseId">
                                            <div>
                                                <strong>Match @match.Number</strong>
                                                @if (match.IsComplete)
                                                {
                                                    <span class="badge bg-success ms-2">@(new MarkupString("&#10003;")) Complete</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning ms-2">In Progress</span>
                                                }
                                            </div>
                                        </button>
                                    </h5>
                                </div>

                                <div id="@collapseId"
                                     class="collapse @(isLatestMatch ? "show" : "")"
                                     aria-labelledby="heading-set@(selectedSet.Number)-match@(match.Number)">
                                    <div class="card-body">
                                        <!-- Courts for this match -->
                                        <div class="row g-3">
                                            @foreach (var court in match.Courts)
                                            {
                                                <div class="col-12 col-md-6 col-xl-4">
                                                    <div class="card @(court.WinningTeam.HasValue ? "border-success" : "")">
                                                        <div class="card-header bg-light">
                                                            <strong>Court @court.Number</strong>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- Teams: Stack on mobile, side-by-side on desktop -->
                                                            <div class="row g-2">
                                                                <!-- Team A -->
                                                                <div class="col-12 col-md-6">
                                                                    <div class="p-2 @(court.WinningTeam == 1 ? "bg-success bg-opacity-10 border border-success rounded" : "border rounded")">
                                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                                            <strong>Team A</strong>
                                                                            @if (court.WinningTeam == 1)
                                                                            {
                                                                                <span class="badge bg-success">Winner</span>
                                                                            }
                                                                        </div>
                                                                        <div class="d-flex flex-wrap gap-1">
                                                                            @foreach (var playerNum in court.TeamA.PlayerNumbers)
                                                                            {
                                                                                <span class="badge bg-primary fs-6">P@(playerNum)</span>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Team B -->
                                                                <div class="col-12 col-md-6">
                                                                    <div class="p-2 @(court.WinningTeam == 2 ? "bg-success bg-opacity-10 border border-success rounded" : "border rounded")">
                                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                                            <strong>Team B</strong>
                                                                            @if (court.WinningTeam == 2)
                                                                            {
                                                                                <span class="badge bg-success">Winner</span>
                                                                            }
                                                                        </div>
                                                                        <div class="d-flex flex-wrap gap-1">
                                                                            @foreach (var playerNum in court.TeamB.PlayerNumbers)
                                                                            {
                                                                                <span class="badge bg-primary fs-6">P@(playerNum)</span>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Record Result Buttons (if match not complete) -->
                                                            @if (!match.IsComplete && court.WinningTeam == null)
                                                            {
                                                                <div class="mt-3 d-grid gap-2">
                                                                    <button class="btn btn-success" 
                                                                            style="min-height: 48px;"
                                                                            @onclick="() => RecordWinner(court.Number, 1)">
                                                                        Team A Wins
                                                                    </button>
                                                                    <button class="btn btn-success" 
                                                                            style="min-height: 48px;"
                                                                            @onclick="() => RecordWinner(court.Number, 2)">
                                                                        Team B Wins
                                                                    </button>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Post-Match Actions (only show if match is complete and set is NOT complete) -->
                                        @if (match.IsComplete && !selectedSet.IsComplete && match.Number == selectedSet.Matches.Count)
                                        {
                                            <div class="alert alert-info mt-3">
                                                <h6>What's next?</h6>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary" 
                                                            style="min-height: 48px;"
                                                            @onclick="ContinueWithCurrentTeams">
                                                        Continue with Teams
                                                    </button>
                                                    <button class="btn btn-success" 
                                                            style="min-height: 48px;"
                                                            @onclick="ReassignTeams">
                                                        New Teams (New Set)
                                                    </button>
                                                </div>
                                                <small class="text-muted d-block mt-2">
                                                    <strong>Continue:</strong> Same teams rotate courts ("up and down the ladder")<br />
                                                    <strong>Re-assign:</strong> New teams balanced by scores (snake draft)
                                                </small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Remix Teams Button (first match only, before it starts) -->
                        @if (selectedSet.Number == 1 && selectedSet.Matches.Count == 1 && !selectedSet.Matches[0].IsComplete)
                        {
                            <div class="mt-3">
                                <button class="btn btn-outline-warning w-100 w-md-auto" 
                                        style="min-height: 48px;"
                                        @onclick="RemixTeams">
                                    Remix Teams
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted mt-5">
                        <p>Select a set from the left to view details</p>
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center text-muted mt-5">
        <p>No sets to display</p>
    </div>
}

<!-- Player Scores Modal -->
<PlayerScoresModal IsVisible="@showScoresModal" 
                   Players="@playerStandings" 
                   OnClose="@HideScoresModal" />

<!-- End Session Confirmation Modal -->
<div class="modal fade @(showEndSessionConfirmation ? "show d-block" : "")" tabindex="-1" style="@(showEndSessionConfirmation ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm End Session</h5>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to end this session?</p>
                <p class="text-muted">Final scores will be displayed and the session will be marked as complete.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CancelEndSession">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmEndSession">End Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Final Scores Modal -->
<FinalScoresModal IsVisible="@showFinalScoresModal" 
                  Players="@playerStandings" 
                  TotalMatches="@totalMatchesPlayed"
                  OnClose="@CloseFinalScores" />
